CREATE DATABASE ERPDatabase
ON PRIMARY
  ( NAME = ERPDatabase,
    FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\ERPDatabase.mdf',
    SIZE = 8 MB,
    MAXSIZE = UNLIMITED,
    FILEGROWTH = 64 MB )
LOG ON
  ( NAME = ERPDatabase_log,
    FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\ERPDatabase_log.ldf',
    SIZE = 8 MB,
    MAXSIZE = 2097152 MB,
    FILEGROWTH = 64 MB )
COLLATE Polish_CI_AS
GO

CREATE TABLE dbo.Warehouse (
  Id int NOT NULL,
  Name nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE TABLE dbo.VAT (
  Id int IDENTITY(0, 1) NOT NULL,
  PayRate numeric(3, 1) NOT NULL,
  Name nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE TABLE dbo.Product (
  Id int IDENTITY(0, 1) NOT NULL,
  Name nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  Code nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE TABLE dbo.Contractor (
  Id int IDENTITY(0, 1) NOT NULL,
  Name nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  ShortName nvarchar(30) COLLATE Polish_CI_AS NOT NULL,
  IsOwner bit DEFAULT 0 NOT NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE TABLE dbo.InvoiceHeader (
  Id int IDENTITY(1, 1) NOT NULL,
  IdBuyer int NOT NULL,
  IdSeller int NOT NULL,
  IsPriceNet bit NULL,
  IsVatSummed bit NULL,
  CreationDate datetime2(7) NOT NULL,
  PaymentDate datetime2(7) NOT NULL,
  CONSTRAINT InvoiceHeader_pk PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON),
  UNIQUE (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON),
  CONSTRAINT InvoiceHeader_fk FOREIGN KEY (IdBuyer) 
  REFERENCES dbo.Contractor (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION,
  CONSTRAINT InvoiceHeader_fk2 FOREIGN KEY (IdSeller) 
  REFERENCES dbo.Contractor (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX InvoiceHeader_idx_IdBuyer ON dbo.InvoiceHeader
  (IdBuyer)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX InvoiceHeader_idx_IdSeller ON dbo.InvoiceHeader
  (IdSeller)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX InvoiceHeader_idx_PaymentDate ON dbo.InvoiceHeader
  (PaymentDate)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE TABLE dbo.InvoicePosition (
  Id int NOT NULL,
  IdProduct int NOT NULL,
  IdHeader int NOT NULL,
  IdVat int NOT NULL,
  Value money NOT NULL,
  Price money NOT NULL,
  Amount numeric(12, 4) NOT NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON),
  CONSTRAINT Position_fk FOREIGN KEY (IdProduct) 
  REFERENCES dbo.Product (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION,
  CONSTRAINT Position_fk2 FOREIGN KEY (IdHeader) 
  REFERENCES dbo.InvoiceHeader (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION,
  CONSTRAINT Position_fk3 FOREIGN KEY (IdVat) 
  REFERENCES dbo.VAT (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX InvoicePosition_idx_IdProduct ON dbo.InvoicePosition
  (IdProduct)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX InvoicePosition_idx_IdVat ON dbo.InvoicePosition
  (IdVat)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE TABLE dbo.WarehouseDocumentHeader (
  Id int NOT NULL,
  DocumentDate date NULL,
  IssueDate date NULL,
  IdIssuer int NULL,
  IdContractor int NULL,
  PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
)
ON [PRIMARY]
GO

CREATE NONCLUSTERED INDEX whdHdrIndxDocDate ON dbo.WarehouseDocumentHeader
  (DocumentDate)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
GO

CREATE TABLE dbo.WarehouseDocumentPosition (
  Id int NOT NULL,
  IdWarehouseDocumentHeader int NOT NULL,
  Position int NOT NULL,
  IdProduct int NULL,
  Quantity int NULL,
  UnitPrice money NULL,
  CONSTRAINT PK_whdPos_uq PRIMARY KEY CLUSTERED (Id)
    WITH (
      PAD_INDEX = OFF, IGNORE_DUP_KEY = OFF, STATISTICS_NORECOMPUTE = OFF,
      ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON),
  CONSTRAINT IdWarehouseDocumentHeader FOREIGN KEY (IdWarehouseDocumentHeader) 
  REFERENCES dbo.WarehouseDocumentHeader (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
)
ON [PRIMARY]
GO

ALTER TABLE dbo.Warehouse
ADD IdOwner int NOT NULL
GO

ALTER TABLE dbo.Warehouse
ADD CONSTRAINT Warehouse_fk FOREIGN KEY (IdOwner) 
  REFERENCES dbo.Contractor (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO

ALTER TABLE dbo.WarehouseDocumentHeader
ADD IdWarehouse int NOT NULL
GO

ALTER TABLE dbo.WarehouseDocumentHeader
ADD CONSTRAINT WarehouseDocumentHeader_fk FOREIGN KEY (IdIssuer) 
  REFERENCES dbo.Contractor (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO

ALTER TABLE dbo.WarehouseDocumentHeader
ADD CONSTRAINT WarehouseDocumentHeader_fk2 FOREIGN KEY (IdContractor) 
  REFERENCES dbo.Contractor (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentHeader_idx_IssueDate ON dbo.WarehouseDocumentHeader
  (IssueDate)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentHeader_idx_IdIssuer ON dbo.WarehouseDocumentHeader
  (IdIssuer)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentHeader_idx_IdContractor ON dbo.WarehouseDocumentHeader
  (IdContractor)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentHeader_idx_IdWarehouse ON dbo.WarehouseDocumentHeader
  (IdWarehouse)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

ALTER TABLE dbo.WarehouseDocumentPosition
ADD CONSTRAINT WarehouseDocumentPosition_fk FOREIGN KEY (IdProduct) 
  REFERENCES dbo.Product (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentPosition_idx_IdWarehouseDocumentHeader ON dbo.WarehouseDocumentPosition
  (IdWarehouseDocumentHeader)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentPosition_idx_IdProduct ON dbo.WarehouseDocumentPosition
  (IdProduct)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

ALTER TABLE dbo.WarehouseDocumentPosition
ADD IdInvoicePosition int NULL
GO

ALTER TABLE dbo.WarehouseDocumentPosition
ADD CONSTRAINT WarehouseDocumentPosition_fk2 FOREIGN KEY (IdInvoicePosition) 
  REFERENCES dbo.InvoicePosition (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO

CREATE NONCLUSTERED INDEX WarehouseDocumentPosition_idx_IdInvoicePosition ON dbo.WarehouseDocumentPosition
  (IdInvoicePosition)
WITH (
  PAD_INDEX = OFF,
  DROP_EXISTING = OFF,
  STATISTICS_NORECOMPUTE = OFF,
  SORT_IN_TEMPDB = OFF,
  ONLINE = OFF,
  ALLOW_ROW_LOCKS = ON,
  ALLOW_PAGE_LOCKS = ON)
GO

ALTER TABLE dbo.InvoicePosition
DROP CONSTRAINT Position_fk2
GO

ALTER TABLE dbo.InvoicePosition
ADD CONSTRAINT Position_fk2 FOREIGN KEY (IdHeader) 
  REFERENCES dbo.InvoiceHeader (Id) 
  ON UPDATE NO ACTION
  ON DELETE CASCADE
GO

ALTER TABLE dbo.WarehouseDocumentPosition
DROP CONSTRAINT IdWarehouseDocumentHeader
GO

ALTER TABLE dbo.WarehouseDocumentPosition
ADD CONSTRAINT IdWarehouseDocumentHeader FOREIGN KEY (IdWarehouseDocumentHeader) 
  REFERENCES dbo.WarehouseDocumentHeader (Id) 
  ON UPDATE NO ACTION
  ON DELETE CASCADE
GO

ALTER TABLE dbo.WarehouseDocumentHeader
ADD CONSTRAINT WarehouseDocumentHeader_fk3 FOREIGN KEY (IdWarehouse) 
  REFERENCES dbo.Warehouse (Id) 
  ON UPDATE NO ACTION
  ON DELETE NO ACTION
GO